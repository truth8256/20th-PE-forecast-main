# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“˜ 20pe_raw.csv / 21pe_raw.csv
# í•œê¸€ ì¸ì½”ë”© ëŒ€ì‘ + í•œê¸€ì§€ì—­ëª… â†’ ì˜ì–´ë¡œ ë³€í™˜ í›„ ì €ì¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

library(readr)
library(dplyr)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ ë³€í™˜ ê·œì¹™ ì •ì˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cluster_map <- c(
  "ì„œìš¸íŠ¹ë³„ì‹œ" = "Seoul",
  "ê²½ê¸°ë„" = "Gyeonggi-do",
  "ì¸ì²œê´‘ì—­ì‹œ" = "Incheon",
  "ëŒ€ì „ê´‘ì—­ì‹œ" = "Daejeon",
  "ì¶©ì²­ë¶ë„" = "Chungcheongbuk-do",
  "ì¶©ì²­ë‚¨ë„" = "Chungcheongnam-do",
  "ê´‘ì£¼ê´‘ì—­ì‹œ" = "Gwangju",
  "ì „ë¼ë¶ë„" = "Jeollabuk-do",
  "ì „ë¶íŠ¹ë³„ìì¹˜ë„" = "Jeollabuk-do",
  "ì „ë¼ë‚¨ë„" = "Jeollanam-do",
  "ëŒ€êµ¬ê´‘ì—­ì‹œ" = "Daegu",
  "ê²½ìƒë¶ë„" = "Gyeongsangbuk-do",
  "ë¶€ì‚°ê´‘ì—­ì‹œ" = "Busan",
  "ê²½ìƒë‚¨ë„" = "Gyeongsangnam-do",
  "ê°•ì›ë„" = "Gangwon-do",
  "ê°•ì›íŠ¹ë³„ìì¹˜ë„" = "Gangwon-do",
  "ì œì£¼íŠ¹ë³„ìì¹˜ë„" = "Jeju-do",
  "ìš¸ì‚°ê´‘ì—­ì‹œ" = "Ulsan",
  "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ" = "Sejong-si"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ 20ëŒ€ ëŒ€ì„  ë°ì´í„°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# ì¸ì½”ë”© ìë™ ê°ì§€ (readrê°€ ì˜ ì•ˆë  ê²½ìš° euc-kr ëª…ì‹œ)
pe20 <- tryCatch(
  read_csv("0_data/20pe_raw.csv", locale = locale(encoding = "euc-kr"), show_col_types = FALSE),
  error = function(e) read.csv("0_data/20pe_raw.csv", fileEncoding = "CP949")
)

if (!"primary_cluster" %in% names(pe20)) {
  cand <- intersect(names(pe20), c("ì‹œë„", "ê´‘ì—­ì‹œë„", "ì§€ì—­", "region"))
  if (length(cand) == 0) stop("âŒ 20pe_raw.csv: ì§€ì—­ëª… ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
  names(pe20)[names(pe20) == cand[1]] <- "primary_cluster"
}

# í•œê¸€ â†’ ì˜ì–´ ì§€ì—­ëª… ë³€í™˜
pe20 <- pe20 %>%
  mutate(primary_cluster = recode(primary_cluster, !!!cluster_map))

cat("\nâœ… 20pe.csv ì§€ì—­ëª… ë³€í™˜ ê²°ê³¼:\n")
print(table(pe20$primary_cluster, useNA = "ifany"))

write_csv(pe20, "0_data/20pe.csv")
cat("\nğŸ’¾ ì €ì¥ ì™„ë£Œ â†’ 0_data/20pe.csv\n")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ 21ëŒ€ ëŒ€ì„  ë°ì´í„°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

pe21 <- read_csv("0_data/21pe_raw.csv")


if (!"primary_cluster" %in% names(pe21)) {
  cand <- intersect(names(pe21), c("ì‹œë„", "ê´‘ì—­ì‹œë„", "ì§€ì—­", "region"))
  if (length(cand) == 0) stop("âŒ 21pe_raw.csv: ì§€ì—­ëª… ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
  names(pe21)[names(pe21) == cand[1]] <- "primary_cluster"
}

pe21 <- pe21 %>%
  mutate(primary_cluster = recode(primary_cluster, !!!cluster_map))

cat("\nâœ… 21pe.csv ì§€ì—­ëª… ë³€í™˜ ê²°ê³¼:\n")
print(table(pe21$primary_cluster, useNA = "ifany"))

write_csv(pe21, "0_data/21pe.csv")
cat("\nğŸ’¾ ì €ì¥ ì™„ë£Œ â†’ 0_data/21pe.csv\n")
